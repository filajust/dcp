#!/bin/bash
set -e

log_msg() {
  printf >&2 "\033[0;37m[%s]:\033[0m %s\n" "$(date +"%H:%M:%S")" "$1"
}

fatal() {
  printf >&2 "\033[1;37;41m[FATAL]:\033[0m %s\n" "$1"
  exit 1
}

clone_repo() {
  local name="$(basename "$1")"
  name="${name%.*}"

  if [[ ! -e "$2" ]]; then
    log_msg "Cloning ${name} into $2..."
    git clone --quiet --recursive "$1" "$2" &>/dev/null
    log_msg "Finished."
    did_something="yep"
  else
    log_msg "$2 already exists, skipping..."
  fi
  printf >&2 "\n"
}

DCP="${HOME}/.dcp"
dotvim_dir="${HOME}/.vim"
ZSH="${HOME}/.oh-my-zsh"
zsh_highlight_dir="${ZSH}/custom/plugins/zsh-syntax-highlighting"

[[ "${USER}" = "danpoggi" ]] &&
  git_base="git@github.com:dpoggi" ||
  git_base="https://github.com/dpoggi"
dcp_git="${git_base}/dcp.git"
dotvim_git="${git_base}/dotvim.git"
zsh_git="${git_base}/oh-my-zsh.git"
zsh_highlight_git="https://github.com/zsh-users/zsh-syntax-highlighting.git"

hash git 2>/dev/null || fatal "Unable to find Git."

did_something="nope"

clone_repo "${dcp_git}" "${DCP}"
clone_repo "${dotvim_git}" "${dotvim_dir}"

clone_repo "${zsh_git}" "${ZSH}"
clone_repo "${zsh_highlight_git}" "${zsh_highlight_dir}"

log_msg "Running update script..."
export PATH="${PATH}:${DCP}/bin"
printf >&2 "\n"
"${DCP}/bin/dcp-update"

if [[ "${did_something}" = "yep" ]]; then
  printf >&2 "\n"
  log_msg "Tip: restart your terminal, or do \`exec $(basename "${SHELL}")' now."
  log_msg "To compile Command-T for Vim, after \`rbenv shell system' if necessary, do:"
  log_msg "\`cd ~/.vim/bundle/command-t && /usr/bin/rake make'"
fi
