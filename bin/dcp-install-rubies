#!/usr/bin/env bash

# Check for some prerequisites
[[ "$(uname)" = "Darwin" ]] ||
  { echo >&2 "Error: script is only for Mac OS X 10.8 (Mountain Lion)."; exit 1; }
[[ -d "$HOME/.rvm" ]] ||
  { echo >&2 "Error: RVM not installed!"; exit 1; }
hash 2>/dev/null gcc-4.2 ||
  { echo >&2 "Error: gcc-4.2 not installed! Use Homebrew!"; exit 1; }

# This hack is because OpenSSL will fail to compile if these directories aren't
# pre-made.
mkdir -p $rvm_path/usr/lib
mkdir -p $rvm_path/usr/include
mkdir -p $rvm_path/usr/share
mkdir -p $rvm_path/usr/info
mkdir -p $rvm_path/usr/man

# This hack is because OpenSSL isn't compatible with parallel builds using make.
# Their Makefile, when generated, doesn't include enough dependency chaining
# information for make to work properly in parallel. Seeing a pattern here with
# all the hacks being for OpenSSL?
TMP="$MAKEFLAGS"
MAKEFLAGS=""
rvm pkg install openssl
MAKEFLAGS="$TMP"
rvm pkg install readline --verify-downloads 1

rvm install 1.8.7 --with-gcc=gcc-4.2 --with-openssl-dir=$rvm_path/usr --with-readline-dir=$rvm_path/usr
rvm install 1.9.3 --with-gcc=gcc-4.2 --with-opt-dir=$rvm_path/usr
