#!/bin/bash

log_msg() {
  printf >&2 "\033[0;37m[%s]:\033[0m %s\n" "$(date +"%H:%M:%S")" "$1"
}

fatal() {
  printf >&2 "\033[1;37;41m[FATAL]:\033[0m %s\n" "$1"
  exit 1
}

clone_repo() {
  local name="$(basename "$1")"
  name="${name%.*}"

  log_msg "Cloning ${name} into $2..."
  export GIT_DIR="$(basename "$2")/.git"
  git clone --quiet --recursive "$1" "$2" &>/dev/null
  log_msg "Finished."
  printf >&2 "\n"
}

git_base="https://github.com/dpoggi"

[[ "$#" -gt "0" ]] || fatal "Usage: $(basename "$0") <archive.tar.xz>"
[[ ! -e "$1" ]] || fatal "Archive already exists."
dir="$(mktemp -q -d /tmp/dcp-package-XXXXXX)"
[[ -n "${dir}" ]] || fatal "Couldn't create temporary directory."

# Resolve path
pushd "$(dirname "${dir}")" >/dev/null
dir="$(pwd -P)/$(basename "${dir}")"
popd >/dev/null

pushd "${dir}" >/dev/null
clone_repo "${git_base}/dcp.git" \
           ".dcp"
clone_repo "${git_base}/dotvim.git" \
           ".vim"
clone_repo "${git_base}/oh-my-zsh.git" \
           ".oh-my-zsh"
clone_repo "https://github.com/zsh-users/zsh-syntax-highlighting.git" \
           ".oh-my-zsh/custom/plugins/zsh-syntax-highlighting"

pushd ".vim" >/dev/null
log_msg "Updating submodules for dotvim..."
export GIT_DIR=".git"
git submodule update --init --quiet --recursive
scripts/post_update.sh
log_msg "Finished."
printf >&2 "\n"
popd >/dev/null

pushd ".oh-my-zsh/custom/plugins/zsh-syntax-highlighting" >/dev/null
log_msg "Checking out latest version of zsh-syntax-highlighting..."
git checkout --quiet --force "$(git describe --abbrev=0 --tags)"
log_msg "Finished."
printf >&2 "\n"
popd >/dev/null

log_msg "Compressing archive..."
tar -cJf "$(basename "$1")" ".oh-my-zsh" ".dcp" ".vim"
popd >/dev/null

log_msg "Moving archive..."
mv "${dir}/$(basename "$1")" .

log_msg "Cleaning up..."
[[ -d "${dir}" ]] && rm -rf "${dir}"
log_msg "Done."
