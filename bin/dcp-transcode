#!/bin/bash

fail() {
  [[ "$#" -gt "0" ]] || return
  printf >&2 "Fatal: %s\n" "$1"
  exit 1
}
log_msg() {
  [[ "$#" -gt "0" ]] || return
  printf >&2 "%s\t%s\n" "$(date -u "+%Y-%m-%dT%H:%M:%SZ")" "$1"
}

[[ "$#" -gt "0" ]] || fail "no input file."
hash 2>&- ffmpeg || fail "ffmpeg could not be found."
hash 2>&- afconvert || fail "afconvert could not be found."

base="${1%.*}"
video="${base}_video.mkv"
wav="${base}.wav"
caf="${base}.caf"
aac="${base}.m4a"
output="${base}.mp4"
[[ -e "${output}" ]] && output="${base}_out.mp4"

log_msg "Extracting video as-is..."
ffmpeg -i "$1" -an -c:v copy "${video}" 2>/dev/null
log_msg "Converting audio from source -> WAV..."
ffmpeg -i "$1" -vn -c:a pcm_s16le -ac 2 "${wav}" 2>/dev/null

log_msg "Converting audio from WAV -> CAF..."
afconvert "${wav}" "${caf}" -d 0 -f caff --soundcheck-generate
log_msg "Converting audio from CAF -> AAC..."
afconvert "${caf}" "${aac}" -d aac -f m4af -u pgcm 2 -b 256000 -q 127 -s 2 --soundcheck-read

log_msg "Muxing..."
ffmpeg -i "${video}" -i "${aac}" -c:v copy -c:a copy "${output}" 2>/dev/null

log_msg "Cleaning up intermediate files..."
rm -f "${video}" "${wav}" "${caf}" "${aac}"
log_msg "Done."
