#!/bin/bash

fatal() {
  if [[ -n "$1" ]]; then
    printf >&2 "Fatal: $1\n"
  else
    printf >&2 "Fatal error.\n"
  fi
  exit 1
}

get_initctl_path() {
  local initctl initctl_path
  for initctl in launchctl initctl systemctl service; do
    initctl_path="$(type -P "${initctl}")"
    if [[ -x "${initctl_path}" ]]; then
      printf "${initctl_path}"
      return
    fi
  done
}

get_initctl_config_path() {
  local config_path
  for config_path in /System/Library/LaunchDaemons/${1}.plist \
                     /System/Library/LaunchAgents/${1}.plist \
                     /Library/LaunchDaemons/${1}.plist \
                     /Library/LaunchAgents/${1}.plist \
                     "${HOME}"/Library/LaunchDaemons/${1}.plist \
                     /usr/lib/systemd/system/${1} \
                     /usr/lib/systemd/system/${1}.service \
                     /etc/init/${1}.conf; do
    if [[ -e "${config_path}" ]]; then
      printf "${config_path}"
      return
    fi
  done
}

get_initscript_path() {
  local initscript_path
  for initscript_path in /etc/init.d/$1 /etc/init.d/rc.d/$1 /etc/rc.d/$1; do
    if sudo test -x "${initscript_path}"; then
      printf "${initscript_path}"
      return
    fi
  done
}

initctl() {
  local initctl_config_file="$(basename "$3")"
  local service_name="${initctl_config_file%.*}"
  local initctl_type="$(basename "$1")"

  if [[ "${initctl_type}" = "launchctl" ]]; then
    if [[ "$2" = "start" ]]; then
      sudo "$1" load -F "$3"
    elif [[ "$2" = "stop" ]]; then
      sudo "$1" load -F "$3"
    fi
  elif [[ "${initctl_type}" = "initctl" ]]; then
    sudo "$1" "$2" "${service_name}"
  elif [[ "${initctl_type}" = "systemctl" ]]; then
    sudo "$1" "$2" "${initctl_config_file}"
  elif [[ "${initctl_type}" = "service" ]]; then
    sudo "$1" "${service_name}" "$2"
  fi
}

run() {
  export PATH="/usr/bin:/bin:/usr/local/bin:/usr/sbin:/sbin:/usr/local/sbin"

  local initctl_path="$(get_initctl_path)"
  local initctl_config_path="$(get_initctl_config_path "$2")"
  local initscript_path="$(get_initscript_path "$2")"

  if [[ -n "${initctl_path}" && -n "${initctl_config_path}" ]]; then
    initctl "${initctl_path}" "$1" "${initctl_config_path}"
  elif [[ -n "${initscript_path}" ]]; then
    sudo "${initscript_path}" "$1"
  else
    fatal "Couldn't find a way to control ${2}."
  fi
}

if [[ "$#" -ge "2" ]]; then
  run "$@"
else
  printf >&2 "Usage: $(basename "$0") {action} {service}\n"
fi
