#!/bin/bash
set -e

fatal() {
  printf >&2 "\033[1;37;41m[FATAL]:\033[0m %s\n" "$1"
  exit "${2:-1}"
}

clone_repo() {
  local name="$(basename "${1%.*}")"
  printf >&2 "Cloning ${name}...\n"
  mkdir -p "$2"
  git clone --quiet "$1" "$2"
  pushd "$2" >/dev/null
  local tag="$(git describe --abbrev=0 --tags 2>/dev/null)"
  if [[ -n "${tag}" ]]; then
    printf >&2 "Checking out the latest version of ${name}...\n"
    git checkout --quiet --force "${tag}"
  fi
  printf "\n"
  popd >/dev/null
}

declare -a git_urls clone_dirs formulae
while [[ "$#" -gt "0" ]]; do
  git_urls+=( "$1" )
  clone_dirs+=( "$2" )
  formulae+=( "$(basename "${1%.*}")" )
  shift 2 || true
done

vm="${formulae[0]}"
install_dir="~/$(basename "${clone_dirs[0]}")"

[[ "${UID}" != "0" ]] || fatal "Cannot run as root."
hash "${vm}" 2>/dev/null && fatal "${vm} found in \$PATH." || true
[[ ! -d "${clone_dirs[0]}" ]] || fatal "${install_dir} already exists."

if [[ "$(uname -s)" = "Darwin" ]] && hash brew 2>/dev/null; then
  printf >&2 "Installing via Homebrew...\n\n"
  brew update
  brew install "${formulae[@]}"
  printf >&2 "Installation via Homebrew successful!\n"
else
  printf >&2 "Installing via Git to ${install_dir}...\n\n"
  for (( i=0; i<${#git_urls[@]}; i++ )); do
    clone_repo "${git_urls[$i]}" "${clone_dirs[$i]}"
  done
  printf >&2 "Installation via Git to ${install_dir} successful!\n"
fi

[[ "${vm}" != *env ]] || mkdir -p "${clone_dirs[0]}/shims"
printf >&2 "Open a new terminal or exec $(basename "${SHELL}") to activate.\n"
